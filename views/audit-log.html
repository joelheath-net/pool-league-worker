<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Log</title>
    <style>
        /* Consistent styling with other pages */
        body { 
            font-family: sans-serif; 
            background-color: #f4f4f9;
            padding: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .audit-log-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .audit-entry {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .audit-entry-header h3 {
            margin: 0 0 5px 0;
            color: #0056b3;
        }
        .audit-entry-header .meta {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .audit-details h4 {
            margin: 0 0 10px 0;
            color: #343a40;
        }
        .audit-details ul {
            list-style-type: none;
            padding-left: 0;
            margin: 0;
        }
        .audit-details li {
            padding: 4px 0;
            color: #495057;
        }
        .loading, .error {
            text-align: center;
            font-size: 1.2em;
            color: #666;
        }
    </style>
</head>
<body>

    <h1>Game Revisions Audit Log</h1>

    <div id="audit-log-container" class="audit-log-container">
        <!-- Audit entries will be dynamically inserted here -->
    </div>

    <script>
        /**
         * Fetches all revisions and users, then populates the audit log.
         */
        async function populateAuditLog() {
            const container = document.getElementById('audit-log-container');
            container.innerHTML = '<p class="loading">Loading audit log...</p>';

            try {
                // 1. Fetch users and log data in parallel
                const [usersResponse, logResponse] = await Promise.all([
                    fetch('/api/users'),
                    fetch('/api/audit-log')
                ]);

                if (!usersResponse.ok || !logResponse.ok) {
                    throw new Error('Failed to fetch required data.');
                }

                const users = await usersResponse.json();
                const auditLog = await logResponse.json();
                const userMap = new Map(users.map(user => [user.id, user]));

                if (auditLog.length === 0) {
                     container.innerHTML = '<p class="loading">No game revisions found.</p>';
                     return;
                }

                // 2. Process each log entry and create its HTML card
                const entriesHtml = auditLog.map(rev => {
                    const author = userMap.get(rev.author_id) || { name: 'Unknown', email: 'N/A' };
                    const player1 = userMap.get(rev.player1_id) || { name: 'Unknown' };
                    const player2 = userMap.get(rev.player2_id) || { name: 'Unknown' };
                    const winner = userMap.get(rev.winner_id) || { name: 'Unknown' };

                    // Format data for display
                    const actionText = rev.revision_id === 0 
                        ? `${author.name} created a new record` 
                        : `${author.name} updated an existing record`;
                    
                    const authoredDate = new Date(rev.authored_at).toLocaleString('en-GB');
                    const playedDate = new Date(rev.played_at).toLocaleDateString('en-GB');
                    const rematchText = rev.rematch_id === 0 ? 'First Match' : `Rematch ${rev.rematch_id}`;
                    const fouledText = rev.fouled_on_black ? 'Yes' : 'No';

                    return `
                        <div class="audit-entry">
                            <div class="audit-entry-header">
                                <h3>${actionText}</h3>
                                <p class="meta">on ${authoredDate} (by ${author.email})</p>
                            </div>
                            <div class="audit-details">
                                <h4>${player1.name} vs. ${player2.name} (${rematchText})</h4>
                                <ul>
                                    <li><strong>Winner:</strong> ${winner.name}</li>
                                    <li><strong>Date Played:</strong> ${playedDate}</li>
                                    <li><strong>Balls Remaining:</strong> ${rev.balls_remaining}</li>
                                    <li><strong>Fouled on Black:</strong> ${fouledText}</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }).join('');

                // 3. Populate the container
                container.innerHTML = entriesHtml;

            } catch (error) {
                console.error("Error populating audit log:", error);
                container.innerHTML = `<p class="error">Failed to load audit log. ${error.message}</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', populateAuditLog);
    </script>

</body>
</html>
